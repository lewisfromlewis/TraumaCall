---
title: "Mitch"
author: "Lewis"
date: "13 July 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Trauma Team Activation Criteria as a predictor of severe trauma; an analysis of the sensitivity and specificity of Royal Darwin Hospital's Trauma Team Callout Criteria.**

*Project Description*
*Background*
Studies have shown that patients who have suffered severe trauma have improved outcomes when a multidisciplinary team and attendant resources are mobilised from other tasks on patient arrival1,2.  In seeking to maximise the benefit of hospital behaviour at the population level, the benefit to severely injured trauma patients is balanced against the effect of removing resources from other areas.  This balance is unlikely to be the same in every trauma centre

Trauma team composition is not closely specified at a national or international level and therefore differs between institutions.  Criteria for trauma team activation also differ mildly between institutions (refs?), as do the characteristics of the patients who arrive at the hospital with trauma and are screened for trauma team activation.  It is inherent in the service specifications that the greatest population benefit would be seen a hospital with a higher proportion of severely injured patients arriving in the early phase of trauma, plus both a low rate and a constant and low illness severity of patients presenting with non traumatic illness.  This logic underlies the recommendations of many mature health systems for a single trauma centre covering a primary population of 2.5 million (refs?).

Our institution, Royal Darwin Hospital, is a remote hospital covering a large geographical area with a small population (ref).  There is a high incidence of severe trauma but long retrieval times are common (ref from Kath's work; if influential we could add a column of "injury time" and do a quick dirty analysis of that) and there is a high population burden of non traumatic illness which is both seasonally varying and unpredictably varying (ref).  The "Trauma Team Callout Criteria" (TTCC) at Royal Darwin Hospital (RDH) include pre hospital (mechanism of injury) and clinical criteria for activation.  Mechanism of injury criteria have low predictive value for severe injury3-5 and may lead to a high rate of over-triage for RDH's trauma patients.

```{r}
## Set up the workspace
setwd("C:/Users/lewis/Documents/CICM/CICM Formal Projects/Cameron M/TraumaCall")
library(tidyverse)
library(lubridate)
library(readxl)
library(car)
library(lmtest)
## Next line is run once then replaced with the .csv file in the repo,as the subsequent line: 
## traumata <- read_xlsx("TraumadataV48.xlsx", sheet = 1, n_max = 784)
traumata <- read_csv("traumata.csv")
```
The severity of the whole cohort for that year is indicated by the median Risk of Death based on the ANZICS APACHEIII score is given below.  The various risk functions give varying risks of death as summarised below, and the standardised mortality ratio across the year is from 0.42 to 0.53 (0.53 using APACHEIII).

```{r}
## Next line is run once then replaced with the .csv file in the repo,as the subsequent line: 
## Backgroundrate <- read_excel("./Cameron M/DeidentNonop2015.xlsx", sheet = 1)
Backgroundrate <- read_csv('Backgroundrate.csv')
deathtable <- table(Backgroundrate$ICUVitalStatus)
deathrate <- (deathtable[2]/deathtable[1])
deathpredictions <- Backgroundrate[,c(31, 33, 37)]
summary(deathpredictions)
predicteddeaths <- sapply(deathpredictions, sum, na.rm=T)
deathprobabilities <- sapply(deathpredictions, sum, na.rm=T)/dim(Deathpredictions)[1]
SMR <- deathrate/deathprobabilities
print(SMR)
```
Major trauma occurred in 31.5% of those with trauma call criteria, but still seen in 8.1% of those without trauma call criteria.  This is a very influential odds ratio of 5.20 (p value 2.2E-16).
```{r}
table(traumata$`Meets TCC`, traumata$`Major Trauma`)
TCCpredictsmajor <- glm(traumata$`Major Trauma`=='yes' ~ traumata$`Meets TCC`, family="binomial")
anova(TCCpredictsmajor, test="Chisq")
```

Trauma call criteria were more often seen in those who died, odds ratio 4.09, p=0.004 by Chi squared.  For information, the background odds of death for those without a trauma call was 0.01 hence odds of death in those with a trauma call were still only 0.05.
```{r}
table(traumata$`Meets TCC`, traumata$`Discharge Status`)
TCCpredictsdeath <- glm(traumata$`Discharge Status`=='Dead' ~ traumata$`Meets TCC`, family = "binomial")
anova(TCCpredictsdeath, test="Chisq")
```
*Values of Criteria*
Examining the informational contribution of trauma call criteria using multivariable logistic regression.  Each component of the trauma call criteria is added sequentially to a multivariable model.  Logistic regression is one of the family of general linear models, which use the value of parameters to predict a response, assuming that the relationship across the values of the parameter holds true.  In each linear model there's a link function, so for a simple linear model it's the identity function, for logistic regression it's the logit function; and there's an assumption about an error structure for the data, in this case I've chosen binomial. So the model produces a set of coefficients, which in this case are the log odds ratio for major trauma for 

The performance of the models in predicting the outcome "Major Trauma" is compared using the likelihood ratio test.  The Likelihood is the probability of the data under a hypothesis.  In all of the calculations below that is the null hypothesis that the coefficient of the logistic 
There are limitations to these comparisons.
```{r}
buildingmodels1 <- glm(`Major Trauma`=='yes' ~ CPR, family = "binomial", data = traumata)
buildingmodels2 <- glm(`Major Trauma`=='yes' ~ `multi?` + CPR + `MVA ejection` + `MVA entrapment`, family = "binomial", data = traumata)
wholemodel <- glm(formula = `Major Trauma`=='yes' ~ CPR + `multi?` + 
                    `MVA ejection` + `MVA entrapment` + 
                    `MVA fatality at scene` + `Bicycle vs car` + 
                    `Ped vs car` + `Pen head` + `Pen neck` + 
                    `Pen torso` + `Crush head` + `Crush torso` + 
                    `Burns >15%` + `Near Drown` + `Blast Injury`, 
                  family = "binomial", data = traumata)
wholemodel
anova(wholemodel, test="Chisq")
vif(wholemodel)
lrtest(wholemodel, buildingmodels1)
```

```{r}
#Close off data manipulations and save current databases
write_csv(traumata, paste("traumata", "Sys.Date()",".csv"))
write_csv(Backgroundrate, "Backgroundrate.csv")
```